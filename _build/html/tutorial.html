

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Building a Recommender System from Scratch &mdash; pydata-tutorial  documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="PyDataDC Recommender System Tutorial" href="index.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> pydata-tutorial
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Building a Recommender System from Scratch</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Step-1:-Import-Dependencies">Step 1: Import Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Step-2:-Load-Data">Step 2: Load Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Step-3:-Exploratory-Data-Analysis">Step 3: Exploratory Data Analysis</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Best-vs.&nbsp;Worst-Movie">Best vs.&nbsp;Worst Movie</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Bayesian-Average">Bayesian Average</a></li>
<li class="toctree-l3"><a class="reference internal" href="#A-Glimpse-at-Movie-Genres">A Glimpse at Movie Genres</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Step-4:-Data-Pre-processing">Step 4: Data Pre-processing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Evaluating-sparsity">Evaluating sparsity</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Step-5:-Item-item-Recommendations-with-k-Nearest-Neighbors">Step 5: Item-item Recommendations with k-Nearest Neighbors</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Step-6:-Handling-the-cold-start-problem">Step 6: Handling the cold-start problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Part-2:-Top-N-recommender">Part 2: Top N recommender</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">pydata-tutorial</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Building a Recommender System from Scratch</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/tutorial.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #D84315;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 8ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}
</style>
<div class="section" id="Building-a-Recommender-System-from-Scratch">
<h1>Building a Recommender System from Scratch<a class="headerlink" href="#Building-a-Recommender-System-from-Scratch" title="Permalink to this headline">¶</a></h1>
<div class="section" id="Step-1:-Import-Dependencies">
<h2>Step 1: Import Dependencies<a class="headerlink" href="#Step-1:-Import-Dependencies" title="Permalink to this headline">¶</a></h2>
<p>We are using
<a class="reference external" href="http://pandas.pydata.org/pandas-docs/version/0.19/generated/pandas.DataFrame.html">pandas.DataFrame</a>
to represent our data. We will visualize our data with
<a class="reference external" href="https://matplotlib.org/">matplotlib</a> and
<a class="reference external" href="https://seaborn.pydata.org/">seaborn</a>.</p>
<p><strong>What is a DataFrame?</strong></p>
<ul class="simple">
<li>a two-dimensional Pandas data structure</li>
<li>columns represent features, rows represent items</li>
<li>analogous to an Excel spreadsheet or SQL table</li>
<li>documentation can be found here</li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Step-2:-Load-Data">
<h2>Step 2: Load Data<a class="headerlink" href="#Step-2:-Load-Data" title="Permalink to this headline">¶</a></h2>
<p>Let’s download a small version of the MovieLens dataset. See here for
zip file url, or directly download here. We’re working with data in
ml-latest-small.zip and will need to add the following files to our
repository:</p>
<ul class="simple">
<li>ratings.csv</li>
<li>movies.csv</li>
</ul>
<p>Alternatively, you can access the data here:</p>
<ul class="simple">
<li><a class="reference external" href="https://s3-us-west-2.amazonaws.com/recommender-tutorial/movies.csv">https://s3-us-west-2.amazonaws.com/recommender-tutorial/movies.csv</a></li>
<li><a class="reference external" href="https://s3-us-west-2.amazonaws.com/recommender-tutorial/ratings.csv">https://s3-us-west-2.amazonaws.com/recommender-tutorial/ratings.csv</a></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ratings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;https://s3-us-west-2.amazonaws.com/recommender-tutorial/ratings.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">movies</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;https://s3-us-west-2.amazonaws.com/recommender-tutorial/movies.csv&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Step-3:-Exploratory-Data-Analysis">
<h2>Step 3: Exploratory Data Analysis<a class="headerlink" href="#Step-3:-Exploratory-Data-Analysis" title="Permalink to this headline">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">n_ratings</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>
<span class="n">n_movies</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="s1">&#39;movieId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
<span class="n">n_users</span> <span class="o">=</span> <span class="n">ratings</span><span class="p">[</span><span class="s1">&#39;userId&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Number of ratings: </span><span class="si">{n_ratings}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Number of unique movieId&#39;s: </span><span class="si">{n_movies}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Number of unique users: </span><span class="si">{n_users}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Average number of ratings per user: {round(n_ratings/n_users, 2)}&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Average number of ratings per movie: {round(n_ratings/n_movies, 2)}&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Number of ratings: 100004
Number of unique movieId&#39;s: 9066
Number of unique users: 671
Average number of ratings per user: 149.04
Average number of ratings per movie: 11.03
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [104]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">sns</span><span class="o">.</span><span class="n">countplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;rating&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">ratings</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Distribution of movie ratings&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/tutorial_9_0.png" src="_images/tutorial_9_0.png" />
</div>
</div>
<div class="section" id="Best-vs.&nbsp;Worst-Movie">
<h3>Best vs.&nbsp;Worst Movie<a class="headerlink" href="#Best-vs. Worst-Movie" title="Permalink to this headline">¶</a></h3>
<p>Which movie has the lowest and highest average rating?</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [61]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">mean_ratings</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;movieId&#39;</span><span class="p">)[[</span><span class="s1">&#39;rating&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">lowest_rated</span> <span class="o">=</span> <span class="n">mean_ratings</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
<span class="n">movies</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">movies</span><span class="p">[</span><span class="s1">&#39;movieId&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">lowest_rated</span><span class="p">]</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>Out[61]:
</pre></div>
</div>
<div class="output_area docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>movieId</th>
      <th>title</th>
      <th>genres</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1062</th>
      <td>1311</td>
      <td>Santa with Muscles (1996)</td>
      <td>Comedy</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Santa</span> <span class="pre">with</span> <span class="pre">Muscles</span></code> has the lowest average rating.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [72]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">highest_rated</span> <span class="o">=</span> <span class="n">mean_ratings</span><span class="p">[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
<span class="n">movies</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">movies</span><span class="p">[</span><span class="s1">&#39;movieId&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">highest_rated</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>Out[72]:
</pre></div>
</div>
<div class="output_area docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>movieId</th>
      <th>title</th>
      <th>genres</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>50</th>
      <td>53</td>
      <td>Lamerica (1994)</td>
      <td>Adventure|Drama</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Lamerica may be the “highest” rated movie, but it only has one rating. A
better approach for evaluating movie popularity is to do look at the
<a class="reference external" href="https://en.wikipedia.org/wiki/Bayesian_average">Bayesian average</a>.</p>
</div>
<div class="section" id="Bayesian-Average">
<h3>Bayesian Average<a class="headerlink" href="#Bayesian-Average" title="Permalink to this headline">¶</a></h3>
<p>Bayesian Average is defined as:</p>
<p><span class="math notranslate nohighlight">\(r_{i} = \frac{C \times m + \Sigma{\text{reviews}}}{C+N}\)</span></p>
<p>where <span class="math notranslate nohighlight">\(C\)</span> represents our confidence, <span class="math notranslate nohighlight">\(m\)</span> represents our
prior, and <span class="math notranslate nohighlight">\(N\)</span> is the total number of reviews for movie <span class="math notranslate nohighlight">\(i\)</span>.
In this case, our prior will be the average rating across all movies. By
defintion, C represents “the typical data set size”. Let’s make
<span class="math notranslate nohighlight">\(C\)</span> be the average number of ratings for a given movie.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [64]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">movie_stats</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;movieId&#39;</span><span class="p">)[[</span><span class="s1">&#39;rating&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">])</span>
<span class="n">movie_stats</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">movie_stats</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">droplevel</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [65]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">C</span> <span class="o">=</span> <span class="n">movie_stats</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">movie_stats</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">bayesian_avg</span><span class="p">(</span><span class="n">ratings</span><span class="p">):</span>
    <span class="n">bayesian_avg</span> <span class="o">=</span> <span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">m</span><span class="o">+</span><span class="n">ratings</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">/</span><span class="p">(</span><span class="n">C</span><span class="o">+</span><span class="n">ratings</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">bayesian_avg</span>

<span class="n">bayesian_avg_ratings</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;movieId&#39;</span><span class="p">)[</span><span class="s1">&#39;rating&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">bayesian_avg</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">bayesian_avg_ratings</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;movieId&#39;</span><span class="p">,</span> <span class="s1">&#39;bayesian_avg&#39;</span><span class="p">]</span>
<span class="n">movie_stats</span> <span class="o">=</span> <span class="n">movie_stats</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">bayesian_avg_ratings</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;movieId&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [73]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">movie_stats</span> <span class="o">=</span> <span class="n">movie_stats</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">movies</span><span class="p">[[</span><span class="s1">&#39;movieId&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">]])</span>
<span class="n">movie_stats</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;bayesian_avg&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>Out[73]:
</pre></div>
</div>
<div class="output_area docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>movieId</th>
      <th>count</th>
      <th>mean</th>
      <th>bayesian_avg</th>
      <th>title</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>318</td>
      <td>311</td>
      <td>4.487138</td>
      <td>4.446203</td>
      <td>Shawshank Redemption, The (1994)</td>
    </tr>
    <tr>
      <th>1</th>
      <td>858</td>
      <td>200</td>
      <td>4.487500</td>
      <td>4.425014</td>
      <td>Godfather, The (1972)</td>
    </tr>
    <tr>
      <th>2</th>
      <td>50</td>
      <td>201</td>
      <td>4.370647</td>
      <td>4.314534</td>
      <td>Usual Suspects, The (1995)</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1221</td>
      <td>135</td>
      <td>4.385185</td>
      <td>4.302614</td>
      <td>Godfather: Part II, The (1974)</td>
    </tr>
    <tr>
      <th>4</th>
      <td>527</td>
      <td>244</td>
      <td>4.303279</td>
      <td>4.259541</td>
      <td>Schindler's List (1993)</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Using the Bayesian average, we see that <code class="docutils literal notranslate"><span class="pre">Shawshank</span> <span class="pre">Redemption</span></code>,
<code class="docutils literal notranslate"><span class="pre">The</span> <span class="pre">Godfather</span></code>, and <code class="docutils literal notranslate"><span class="pre">The</span> <span class="pre">Usual</span> <span class="pre">Suspects</span></code> are the most highly rated
movies. This result makes much more sense since these movies are
critically acclaimed films.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [71]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">movie_stats</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;bayesian_avg&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>Out[71]:
</pre></div>
</div>
<div class="output_area docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>movieId</th>
      <th>count</th>
      <th>mean</th>
      <th>bayesian_avg</th>
      <th>title</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2869</th>
      <td>3593</td>
      <td>19</td>
      <td>1.210526</td>
      <td>1.975099</td>
      <td>Battlefield Earth (2000)</td>
    </tr>
    <tr>
      <th>1242</th>
      <td>1556</td>
      <td>23</td>
      <td>1.652174</td>
      <td>2.183723</td>
      <td>Speed 2: Cruise Control (1997)</td>
    </tr>
    <tr>
      <th>2161</th>
      <td>2701</td>
      <td>47</td>
      <td>2.031915</td>
      <td>2.271446</td>
      <td>Wild Wild West (1999)</td>
    </tr>
    <tr>
      <th>489</th>
      <td>546</td>
      <td>17</td>
      <td>1.735294</td>
      <td>2.347912</td>
      <td>Super Mario Bros. (1993)</td>
    </tr>
    <tr>
      <th>1243</th>
      <td>1562</td>
      <td>47</td>
      <td>2.148936</td>
      <td>2.366224</td>
      <td>Batman &amp; Robin (1997)</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>With Bayesian average, it looks like <code class="docutils literal notranslate"><span class="pre">Battlefield</span> <span class="pre">Earth</span></code>,
<code class="docutils literal notranslate"><span class="pre">Speed</span> <span class="pre">2:</span> <span class="pre">Cruise</span> <span class="pre">Control</span></code> and <code class="docutils literal notranslate"><span class="pre">Wild</span> <span class="pre">Wild</span> <span class="pre">West</span></code> are the worst rated
movies. <code class="docutils literal notranslate"><span class="pre">Santa</span> <span class="pre">with</span> <span class="pre">Muscles</span></code> isn’t so bad after all.</p>
</div>
<div class="section" id="A-Glimpse-at-Movie-Genres">
<h3>A Glimpse at Movie Genres<a class="headerlink" href="#A-Glimpse-at-Movie-Genres" title="Permalink to this headline">¶</a></h3>
<p>The movies dataset needs to be cleaned in two ways:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">genres</span></code> is expressed as a string with a pipe <code class="docutils literal notranslate"><span class="pre">|</span></code> separating each
genre. We will manipulate this string into a list, which will make it
much easier to analyze.</li>
<li><code class="docutils literal notranslate"><span class="pre">title</span></code> currently has (year) appended at the end. We will extract
year from each title string and create a new column for it.</li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [105]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">movies</span><span class="p">[</span><span class="s2">&quot;genres&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">movies</span><span class="p">[</span><span class="s2">&quot;genres&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">))</span>
<span class="n">movies</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>Out[105]:
</pre></div>
</div>
<div class="output_area docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>movieId</th>
      <th>title</th>
      <th>genres</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>Toy Story (1995)</td>
      <td>[Adventure, Animation, Children, Comedy, Fantasy]</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>Jumanji (1995)</td>
      <td>[Adventure, Children, Fantasy]</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>Grumpier Old Men (1995)</td>
      <td>[Comedy, Romance]</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>Waiting to Exhale (1995)</td>
      <td>[Comedy, Drama, Romance]</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>Father of the Bride Part II (1995)</td>
      <td>[Comedy]</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p><strong>How many movie genres are there?</strong></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [106]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">Counter</span>

<span class="n">genre_frequency</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">g</span> <span class="k">for</span> <span class="n">genres</span> <span class="ow">in</span> <span class="n">movies</span><span class="p">[</span><span class="s1">&#39;genres&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">genres</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;There are {len(genre_frequency)} genres.&quot;</span><span class="p">)</span>

<span class="n">genre_frequency</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
There are 20 genres.
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>Out[106]:
</pre></div>
</div>
<div class="output_area highlight-none notranslate"><div class="highlight"><pre>
<span></span>Counter({&#39;Adventure&#39;: 1117,
         &#39;Animation&#39;: 447,
         &#39;Children&#39;: 583,
         &#39;Comedy&#39;: 3315,
         &#39;Fantasy&#39;: 654,
         &#39;Romance&#39;: 1545,
         &#39;Drama&#39;: 4365,
         &#39;Action&#39;: 1545,
         &#39;Crime&#39;: 1100,
         &#39;Thriller&#39;: 1729,
         &#39;Horror&#39;: 877,
         &#39;Mystery&#39;: 543,
         &#39;Sci-Fi&#39;: 792,
         &#39;Documentary&#39;: 495,
         &#39;IMAX&#39;: 153,
         &#39;War&#39;: 367,
         &#39;Musical&#39;: 394,
         &#39;Western&#39;: 168,
         &#39;Film-Noir&#39;: 133,
         &#39;(no genres listed)&#39;: 18})
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [107]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The 5 most common genres: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">genre_frequency</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The 5 most common genres:
 [(&#39;Drama&#39;, 4365), (&#39;Comedy&#39;, 3315), (&#39;Thriller&#39;, 1729), (&#39;Romance&#39;, 1545), (&#39;Action&#39;, 1545)]
</pre></div></div>
</div>
</div>
</div>
<div class="section" id="Step-4:-Data-Pre-processing">
<h2>Step 4: Data Pre-processing<a class="headerlink" href="#Step-4:-Data-Pre-processing" title="Permalink to this headline">¶</a></h2>
<p>We are going to use a technique called colaborative filtering to
generate recommendations for users. This technique is based on the
premise that similar people like similar things.</p>
<p>The first step is to transform our data into a user-item matrix, also
known as a “utility” matrix. In this matrix, rows represent users and
columns represent movies. The beauty of collaborative filtering is that
it doesn’t require any information about the users or the movies user to
generate recommendations.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">create_X()</span></code> function outputs a sparse matrix X with four mapper
dictionaries:</p>
<ul class="simple">
<li><strong>user_mapper</strong>: maps user id to user index</li>
<li><strong>movie_mapper</strong>: maps movie id to movie index</li>
<li><strong>user_inv_mapper</strong>: maps user index to user id</li>
<li><strong>movie_inv_mapper</strong>: maps movie index to movie id</li>
</ul>
<p>We need these dictionaries because they map which row/column of the
utility matrix corresponds to which user/movie id.</p>
<p>Our X (user-item) matrix is a
<a class="reference external" href="https://docs.scipy.org/doc/scipy-0.14.0/reference/generated/scipy.sparse.csr_matrix.html">scipy.sparse.csr_matrix</a>
which stores the data sparsely.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [81]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">create_X</span>

<span class="n">X</span><span class="p">,</span> <span class="n">user_mapper</span><span class="p">,</span> <span class="n">movie_mapper</span><span class="p">,</span> <span class="n">user_inv_mapper</span><span class="p">,</span> <span class="n">movie_inv_mapper</span> <span class="o">=</span> <span class="n">create_X</span><span class="p">(</span><span class="n">ratings</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="Evaluating-sparsity">
<h3>Evaluating sparsity<a class="headerlink" href="#Evaluating-sparsity" title="Permalink to this headline">¶</a></h3>
<p>Here, we calculate sparsity by dividing the number of stored elements by
total number of elements. The number of stored (non-empty) elements in
our matrix is equivalent to the number of ratings in our dataset.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [88]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">n_total</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">n_ratings</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">nnz</span>
<span class="n">sparsity</span> <span class="o">=</span> <span class="n">n_ratings</span><span class="o">/</span><span class="n">n_total</span>
<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Matrix sparsity: {round(sparsity*100,2)}%&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Matrix sparsity: 1.64%
</pre></div></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">csr_matrix.nnz</span></code> counts the stored values in our sparse matrix. The
rest of our cells are empty.</p>
<p>The <strong>cold start problem</strong> is when there are new users and movies in our
matrix that do not have any ratings. In our Movielens dataset, all users
and movies have at least one rating but in general, it’s useful to check
which users and movies have few interactions.</p>
</div>
</div>
<div class="section" id="Step-5:-Item-item-Recommendations-with-k-Nearest-Neighbors">
<h2>Step 5: Item-item Recommendations with k-Nearest Neighbors<a class="headerlink" href="#Step-5:-Item-item-Recommendations-with-k-Nearest-Neighbors" title="Permalink to this headline">¶</a></h2>
<p>We are going to find the <span class="math notranslate nohighlight">\(k\)</span> movies that have the most similar
user engagement vectors for movie <span class="math notranslate nohighlight">\(i\)</span>.</p>
</div>
<div class="section" id="Step-6:-Handling-the-cold-start-problem">
<h2>Step 6: Handling the cold-start problem<a class="headerlink" href="#Step-6:-Handling-the-cold-start-problem" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="Part-2:-Top-N-recommender">
<h2>Part 2: Top N recommender<a class="headerlink" href="#Part-2:-Top-N-recommender" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="index.html" class="btn btn-neutral" title="PyDataDC Recommender System Tutorial" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Jill Cates

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>